# Автосохранение SmartTable

## Описание

Реализовано автосохранение таблицы каждые **1 минуту** (60000 миллисекунд).

## Функции

### 1. Автоматическое сохранение
- Таймер запускается при инициализации приложения
- Каждые 60 секунд автоматически сохраняет открытый файл
- Сохранение происходит молча без диалогов
- Небольшое сообщение "✓ Автосохранение: filename.xlsx" отображается на 3 секунды

### 2. Управление автосохранением

**Через меню:**
```
Файл → ⚙️ Настройки → ✓ Автосохранение (1 мин)
```

Чекбокс позволяет включить/выключить автосохранение в любой момент.

**Программно:**
```python
# Включить
window.set_autosave(True)

# Выключить
window.set_autosave(False)

# Проверить статус
if window.autosave_enabled:
    print("Автосохранение включено")
```

## Реализация

### Добавленные компоненты

1. **self.autosave_timer** - QTimer объект для отсчета времени
2. **self.autosave_enabled** - Флаг включения/выключения (по умолчанию True)

### Методы

**autosave()** - Вызывается каждую минуту
```python
def autosave(self):
    """Автосохранение файла каждую минуту"""
    if self.autosave_enabled and self.current_file_path:
        try:
            self.save_to_file(self.current_file_path, is_autosave=True)
        except Exception as e:
            print(f"Autosave failed: {e}")
```

**set_autosave(enabled)** - Включить/выключить
```python
def set_autosave(self, enabled: bool):
    """Включить/выключить автосохранение"""
    self.autosave_enabled = enabled
    if enabled and self.autosave_timer:
        self.autosave_timer.start()
        self.status_bar.showMessage("Автосохранение включено")
    elif self.autosave_timer:
        self.autosave_timer.stop()
        self.status_bar.showMessage("Автосохранение отключено")
```

**save_to_file()** - Обновлена с поддержкой is_autosave
```python
def save_to_file(self, file_path: str, is_autosave: bool = False):
    # При is_autosave=True:
    # - Молча сохраняет без диалогов
    # - Показывает краткое сообщение
    # - Игнорирует ошибки (выводит в консоль)
```

## Поведение

### Когда работает автосохранение
- ✅ После открытия файла (current_file_path установлен)
- ✅ После сохранения файла через "Сохранить как"
- ✅ Каждые 60 секунд если файл открыт

### Когда НЕ работает автосохранение
- ❌ Новый документ (current_file_path = None)
- ❌ Если автосохранение отключено (autosave_enabled = False)
- ❌ Если возникла ошибка (отправляет в консоль, не раздражает)

## Форматы сохранения

Автосохранение сохраняет в том же формате, в котором был открыт/сохранён файл:
- ✅ .xlsx (Excel)
- ✅ .csv (CSV)
- ✅ .json (JSON)

## Настройки времени

Чтобы изменить интервал автосохранения, найдите в `main_window.py`:

```python
self.autosave_timer.start(60000)  # 60000 миллисекунд = 1 минута
```

Примеры:
- 30 секунд: `30000`
- 2 минуты: `120000`
- 5 минут: `300000`

## Примеры использования

### Получить статус
```python
if app.main_window.autosave_enabled:
    print("Автосохранение активно")
```

### Отключить на время
```python
app.main_window.set_autosave(False)
# Работаем...
app.main_window.set_autosave(True)
```

### Сохранить прямо сейчас
```python
app.main_window.save_file()  # Вручную без диалога
```

## Status Bar сообщения

- **"✓ Автосохранение: file.xlsx"** - Успешно сохранено (3 сек)
- **"Автосохранение включено"** - Когда включили
- **"Автосохранение отключено"** - Когда выключили

## Безопасность

- Автосохранение НЕ вмешивается в ручное сохранение
- Ошибки автосохранения не показывают пользователю диалоги
- Если файл потерян/удален, автосохранение просто выведет ошибку в консоль
- Каждое автосохранение обновляет временную метку файла (updated_at)

## Тестирование

### Ручное тестирование

1. Откройте файл (Ctrl+O)
2. Внесите изменения
3. Ждите 1 минуту
4. Проверьте что файл обновился (дата последнего изменения)
5. Откройте меню Файл → Настройки
6. Выключите "Автосохранение"
7. Внесите изменения
8. Ждите 1 минуту
9. Проверьте что файл НЕ обновился
10. Включите обратно

### Программное тестирование

```python
from pysheets.src.ui.main_window import MainWindow

window = MainWindow()
window.current_file_path = "test.xlsx"

# Проверяем что таймер работает
assert window.autosave_timer.isActive()

# Выключаем
window.set_autosave(False)
assert not window.autosave_timer.isActive()

# Включаем
window.set_autosave(True)
assert window.autosave_timer.isActive()
```

## Заключение

Автосохранение готово к использованию. Оно работает автоматически при открытии файла и может быть включено/выключено через меню.
